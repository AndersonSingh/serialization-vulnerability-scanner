import nmap
from netaddr import IPNetwork


if __name__ == '__main__':

	# store results of scan in this file. 
	results_file = open('nmap_script_results.txt', 'w')

	# fetch file with target ip addresses.
	targets_file = open('targets.txt', 'r')

	# strip new line characters and spaces.
	targets = targets_file.readlines()
	targets = [target.strip() for target in targets]

	weblogic_versions = ['10.3.6.0', '12.1.2.0', '12.1.3.0', '12.2.1.0']

	# run weblogic scan on each target.
	for target in targets:

		print 'Starting Scan For ' + target + '\n'

		nm = nmap.PortScanner()

		nm.scan(hosts=target, arguments='-p9001 -sV -Pn --version-all')


		for host in nm.all_hosts():
			print nm[host]

			for port in nm[host]['tcp']:
				if nm[host]['tcp'][port]['cpe'] == 'cpe:/a:oracle:weblogic_server':

					found_weblogic_version = nm[host]['tcp'][port]['version']

					if found_weblogic_version == '':
						is_vulnerable = 'Unknown'
						found_weblogic_version = 'Unknown'

					if found_weblogic_version in weblogic_versions:
						is_vulnerable = True
					



					# persist results to output file.
					results_file.write('WebLogic Server Found: ' + str(host) + ':' + str(port) + '\n')
					results_file.write('WebLogic Server Version: ' + str(found_weblogic_version) + '\n')
					results_file.write('WebLogic Server Vulnerable: ' + str(is_vulnerable) + '\n\n\n')

		
